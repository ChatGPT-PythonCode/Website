<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cyberdesk Blog • luls.lol</title>
  <link rel="stylesheet" href="style_cyberdesk.css" />
  <style>
    /* Page-only enhancements (keeps your theme, just improves the post-reading experience) */
    .blog-post-view[hidden]{ display:none !important; }
    .blog-post-view{
      text-align: left;
      margin-top: 24px;
      padding: 22px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.35);
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
    }
    .blog-post-header h2{
      margin-top: 10px;
      margin-bottom: 10px;
      line-height: 1.15;
    }
    .blog-post-header{ text-align: left; }
    .blog-post-body{
      text-align: left;
      margin-top: 16px;
      line-height: 1.7;
      font-size: 1.02rem;
    }
    .blog-post-body img{
      max-width: 100%;
      height: auto;
      border-radius: 16px;
      display: block;
      margin: 14px auto;
    }
    .blog-post-body iframe,
    .blog-post-body video{
      max-width: 100%;
      border-radius: 16px;
    }
    .blog-post-body pre{
      overflow:auto;
      padding: 14px;
      border-radius: 14px;
      background: rgba(0,0,0,.45);
      border: 1px solid rgba(255,255,255,.08);
    }
    .blog-post-body a{
      word-break: break-word;
    }
    .blog-post-body ul,
    .blog-post-body ol{
      padding-left: 1.4em;
      margin: 0.8em 0;
    }
    .blog-post-body li{
      margin: 0.35em 0;
    }
    .blog-post-body blockquote{
      margin: 1em 0;
      padding: 0.75em 1em;
      border-left: 4px solid rgba(176,108,255,.6);
      background: rgba(0,0,0,.25);
      border-radius: 12px;
    }
    .blog-post-view .blog-toolbar{ text-align: left; }
    .blog-toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
    }
    .blog-toolbar .btn{
      margin:0;
    }
    .blog-empty{
      opacity:.85;
      padding: 18px;
      border-radius: 16px;
      border: 1px dashed rgba(255,255,255,.15);
      background: rgba(0,0,0,.25);
    }
  </style>
</head>

<body>
  <!-- Cyber Background -->
  <div class="cyber-grid"></div>

  <!-- HEADER -->
  <header class="header">
    <div class="logo">luls<span>.lol</span></div>

    <nav class="nav">
      <a href="index.html">Home</a>
      <a href="index.html#services">Programs</a>
      <a href="index.html#outlet">Digital Outlet</a>
      <a href="uncsdesk.html" class="active">Cyberdesk</a>
      <a href="index.html#downloads">Gaming Tools</a>
      <a href="index.html#about">About</a>
    </nav>
  </header>

  <!-- BLOG PAGE -->
  <main>
    <section id="cyberdesk" class="section blog-section">
      <h2>Cyberdesk <span>Blog</span></h2>
      <p class="section-sub">Latest posts from UNC S Cyberdesk — styled to match this site.</p>

      <!-- LIST VIEW -->
      <div id="cyberdesk-list" class="templates-grid"></div>
      <div id="cyberdesk-loading" class="blog-empty" style="margin-top:14px;">
        Loading latest posts…
      </div>

      <!-- POST VIEW -->
      <div id="cyberdesk-post" class="blog-post-view" hidden>
        <div class="blog-toolbar">
          <button id="back-to-list" class="btn secondary" type="button">← Back to posts</button>
          <a id="post-canonical" class="btn secondary" href="#" target="_blank" rel="noopener" style="display:none;">Open original</a>
        </div>

        <div class="blog-post-header">
          <div id="post-meta" class="blog-meta"></div>
          <h2 id="post-title"></h2>
        </div>

        <div id="post-body" class="blog-post-body"></div>
      </div>

    </section>
  </main>

  <footer class="footer">
    <div class="logo">luls.lol</div>
    <p>© 2025 luls.lol — All rights reserved.</p>
  </footer>

  <!-- CYBERDESK FEED (AUTO-POPULATE, IN-PAGE POSTS, NO IFRAMES) -->
  <script>
    /*
      Uses Blogger's JSON-in-script (JSONP) feed so this works on a static site without CORS issues.
      Feed: https://uncscyberdesk.blogspot.com/feeds/posts/default?alt=json-in-script&callback=renderCyberdesk&max-results=...
    */

    const LIST_EL = document.getElementById("cyberdesk-list");
    const LOADING_EL = document.getElementById("cyberdesk-loading");
    const POST_EL = document.getElementById("cyberdesk-post");
    const BACK_BTN = document.getElementById("back-to-list");
    const POST_META = document.getElementById("post-meta");
    const POST_TITLE = document.getElementById("post-title");
    const POST_BODY = document.getElementById("post-body");
    const POST_CANONICAL = document.getElementById("post-canonical");

    // Map posts by their canonical URL
    const POSTS_BY_URL = new Map();

    function stripHtml(html){
      const tmp = document.createElement("div");
      tmp.innerHTML = html || "";
      return (tmp.textContent || tmp.innerText || "").replace(/\s+/g, " ").trim();
    }

    function extractFirstImage(html){
      const m = (html || "").match(/<img[^>]+src=["']([^"']+)["']/i);
      return m ? m[1] : "";
    }

    function formatDate(iso){
      if(!iso) return "";
      try{
        const d = new Date(iso);
        return d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"numeric" });
      }catch(e){ return ""; }
    }

    // Upgrade Blogger image URLs for better thumbnail quality (common patterns: /s72-c/, /s1600/, /w72-h72-p-k-no-nu/)
    // Upgrade Blogger image URLs for better thumbnail quality
    // Handles older bp.blogspot.com paths (/s72-c/, /s1600/, /w72-h72-.../) and newer googleusercontent params (=s320, =w320-h240-...)
    function upgradeBloggerImage(url, size){
      if(!url) return "";
      const target = size || 800;

      // Force https (avoid mixed-content blocks)
      url = url.replace(/^http:\/\//i, "https://");

      // Pattern A (classic): .../s72-c/... or .../s1600/...
      url = url.replace(/\/s\d+(-c)?\//, `/s${target}-c/`);

      // Pattern B: .../w72-h72-p-k-no-nu/...
      url = url.replace(/\/(w\d+-h\d+)(-[^\/]+)?\//, `/s${target}-c/`);

      // Pattern C (googleusercontent / blogger param): ...=s320... or ...=s320-c...
      url = url.replace(/=s\d+(-c)?/i, `=s${target}$1`);

      // Pattern D (googleusercontent param): ...=w320-h240-<tail>
      url = url.replace(/=w(\d+)-h(\d+)(-[^&]+)?/i, (m,w,h,tail) => {
        const ww = parseInt(w,10);
        const hh = parseInt(h,10);
        const ratio = (ww && hh) ? (hh/ww) : 0.56;
        const newH = Math.max(1, Math.round(target * ratio));
        return `=w${target}-h${newH}${tail || ""}`;
      });

      // Pattern E (rare query params): ?w=...&h=...
      try{
        const u = new URL(url);
        if(u.searchParams.has("w") || u.searchParams.has("h")){
          const w = parseInt(u.searchParams.get("w") || target, 10);
          const h = parseInt(u.searchParams.get("h") || Math.round(target*0.56), 10);
          const ratio = w ? (h / w) : 0.56;
          u.searchParams.set("w", target);
          u.searchParams.set("h", Math.max(1, Math.round(target * ratio)));
          return u.toString();
        }
      }catch(e){ /* ignore */ }

      return url;
    }

    // Upgrade images inside post HTML too
    function upgradeImagesInHtml(html){
      if(!html) return "";
      return html
        .replace(/(<img[^>]+src=")([^"]+)(")/gi, (m,p1,src,p3) => {
          const up = upgradeBloggerImage(src, 1600);
          return p1 + up + p3;
        })
        // remove any script tags for safety
        .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, "");
    }

    function showList(){
      POST_EL.hidden = true;
      LIST_EL.style.display = "";
      LOADING_EL.style.display = POSTS_BY_URL.size ? "none" : "";
      document.title = "Cyberdesk Blog • luls.lol";
      // clear post hash
      if(location.hash.startsWith("#p=")){
        history.replaceState(null, "", location.pathname);
      }
      window.scrollTo({top: 0, behavior: "smooth"});
    }

    function showPost(entry){
      if(!entry) return;

      LIST_EL.style.display = "none";
      LOADING_EL.style.display = "none";
      POST_EL.hidden = false;

      const url = entry._canonicalUrl;
      const title = entry.title?.$t || "Untitled";
      const published = entry.published?.$t || entry.updated?.$t || "";
      const dateStr = formatDate(published);

      POST_META.textContent = (dateStr ? (dateStr + " • ") : "") + "uncscyberdesk";
      POST_TITLE.textContent = title;

      // Use full content when available
      const rawHtml = entry.content?.$t || entry.summary?.$t || "";
      POST_BODY.innerHTML = upgradeImagesInHtml(rawHtml);

      // optional canonical link (kept secondary; primary reading stays in-page)
      if(url){
        POST_CANONICAL.href = url;
        POST_CANONICAL.style.display = "";
      } else {
        POST_CANONICAL.style.display = "none";
      }

      document.title = title + " • Cyberdesk Blog";

      window.scrollTo({top: 0, behavior: "smooth"});
    }

    function openFromHash(){
      if(!location.hash.startsWith("#p=")) return false;
      const url = decodeURIComponent(location.hash.slice(3));
      const entry = POSTS_BY_URL.get(url);
      if(entry){
        showPost(entry);
        return true;
      }
      return false;
    }

    function buildCard(entry){
      const title = entry.title?.$t || "Untitled";
      const published = entry.published?.$t || entry.updated?.$t || "";
      const dateStr = formatDate(published);

      const canonical = (entry.link || []).find(l => l.rel === "alternate")?.href || "";
      entry._canonicalUrl = canonical;

      const contentHtml = entry.content?.$t || entry.summary?.$t || "";
      const excerpt = stripHtml(contentHtml).slice(0, 160) + (stripHtml(contentHtml).length > 160 ? "…" : "");

      let thumb = entry.media$thumbnail?.url || extractFirstImage(contentHtml) || "";
      thumb = upgradeBloggerImage(thumb, 800);

      const card = document.createElement("div");
      card.className = "download-card blog-post-card";
      card.setAttribute("role","article");

      const imgHtml = thumb
        ? `<img class="blog-img" src="${thumb}" loading="lazy" decoding="async" alt="">`
        : `<div class="outlet-placeholder"></div>`;

      card.innerHTML = `
        ${imgHtml}
        <div class="blog-meta">${dateStr ? dateStr + " • " : ""}uncscyberdesk</div>
        <h3>${title}</h3>
        <p>${excerpt}</p>
        <button class="btn secondary open-post" type="button">Open post</button>
      `;

      // Open in-page (no off-site routing)
      card.querySelector(".open-post").addEventListener("click", () => {
        if(!canonical) return;
        location.hash = "p=" + encodeURIComponent(canonical);
        // show immediately if already in memory
        const found = POSTS_BY_URL.get(canonical);
        if(found) showPost(found);
      });

      return { card, canonical };
    }

    function renderCyberdesk(json){
      try{
        LIST_EL.innerHTML = "";
        POSTS_BY_URL.clear();

        const entries = (json && json.feed && json.feed.entry) ? json.feed.entry : [];
        if(!entries.length){
          LOADING_EL.textContent = "No posts found.";
          return;
        }

        entries.forEach(entry => {
          const { card, canonical } = buildCard(entry);
          if(canonical) POSTS_BY_URL.set(canonical, entry);
          LIST_EL.appendChild(card);
        });

        // After list is ready, open a post if the URL hash requested it
        if(!openFromHash()){
          LOADING_EL.style.display = "none";
        }
      }catch(err){
        console.error(err);
        LOADING_EL.textContent = "Couldn't load posts right now.";
      }
    }

    BACK_BTN.addEventListener("click", showList);
    window.addEventListener("hashchange", () => {
      if(!openFromHash()){
        showList();
      }
    });

    // Load JSONP feed (bypasses CORS)
    (function loadCyberdesk(){
      const s = document.createElement("script");
      s.src = "https://uncscyberdesk.blogspot.com/feeds/posts/default?alt=json-in-script&callback=renderCyberdesk&max-results=12";
      document.body.appendChild(s);
    })();
  </script>

</body>
</html>
